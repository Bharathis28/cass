name: Deploy to Google Cloud on Tag

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3

env:
  PROJECT_ID: cass-lite
  REGION: asia-south1
  PYTHON_VERSION: '312'

jobs:
  deploy:
    name: Deploy CASS-Lite v2 to Google Cloud
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # ============================================
      # GOOGLE CLOUD AUTHENTICATION
      # ============================================
      - name: üîë Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: üîß Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # ============================================
      # DEPLOY SCHEDULER CLOUD FUNCTION
      # ============================================
      - name: üöÄ Deploy Scheduler Function (Cloud Functions Gen2)
        id: deploy-scheduler
        continue-on-error: false
        run: |
          cd cloud_functions/scheduler_function

          echo "üì¶ Deploying scheduler function..."
          gcloud functions deploy cass-scheduler \
            --gen2 \
            --runtime=python${{ env.PYTHON_VERSION }} \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=run_scheduler \
            --trigger-http \
            --allow-unauthenticated \
            --timeout=540s \
            --memory=512MB \
            --max-instances=10 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }}" \
            --quiet

          # Get function URL
          SCHEDULER_URL=$(gcloud functions describe cass-scheduler \
            --gen2 \
            --region=${{ env.REGION }} \
            --format='value(serviceConfig.uri)')

          echo "‚úÖ Scheduler deployed: $SCHEDULER_URL"
          echo "scheduler_url=$SCHEDULER_URL" >> $GITHUB_OUTPUT

      # ============================================
      # DEPLOY WORKER CLOUD FUNCTION
      # ============================================
      - name: üîß Deploy Worker Function (Cloud Functions Gen2)
        id: deploy-worker
        continue-on-error: false
        run: |
          cd cloud_functions/worker_job

          echo "üì¶ Deploying worker function..."
          gcloud functions deploy cass-worker \
            --gen2 \
            --runtime=python${{ env.PYTHON_VERSION }} \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=run_worker_job \
            --trigger-http \
            --allow-unauthenticated \
            --timeout=300s \
            --memory=256MB \
            --max-instances=50 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }}" \
            --quiet

          # Get function URL
          WORKER_URL=$(gcloud functions describe cass-worker \
            --gen2 \
            --region=${{ env.REGION }} \
            --format='value(serviceConfig.uri)')

          echo "‚úÖ Worker deployed: $WORKER_URL"
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT

      # ============================================
      # DEPLOY DASHBOARD TO CLOUD RUN
      # ============================================
      - name: üìä Deploy Dashboard (Cloud Run)
        id: deploy-dashboard
        continue-on-error: false
        run: |
          cd dashboard

          echo "üì¶ Building and deploying dashboard..."
          gcloud run deploy cass-lite-dashboard \
            --source=. \
            --platform=managed \
            --region=${{ env.REGION }} \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300s \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }}" \
            --quiet

          # Get service URL
          DASHBOARD_URL=$(gcloud run services describe cass-lite-dashboard \
            --platform=managed \
            --region=${{ env.REGION }} \
            --format='value(status.url)')

          echo "‚úÖ Dashboard deployed: $DASHBOARD_URL"
          echo "dashboard_url=$DASHBOARD_URL" >> $GITHUB_OUTPUT

      # ============================================
      # VERIFY DEPLOYMENTS
      # ============================================
      - name: ‚úÖ Verify Deployments
        id: verify
        continue-on-error: true
        run: |
          echo "üîç Verifying deployments..."

          # Check scheduler function
          SCHEDULER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ steps.deploy-scheduler.outputs.scheduler_url }}" || echo "000")

          # Check worker function
          WORKER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ steps.deploy-worker.outputs.worker_url }}" || echo "000")

          # Check dashboard
          DASHBOARD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ steps.deploy-dashboard.outputs.dashboard_url }}" || echo "000")

          echo "scheduler_status=$SCHEDULER_STATUS" >> $GITHUB_OUTPUT
          echo "worker_status=$WORKER_STATUS" >> $GITHUB_OUTPUT
          echo "dashboard_status=$DASHBOARD_STATUS" >> $GITHUB_OUTPUT

          echo "üì° Scheduler HTTP: $SCHEDULER_STATUS"
          echo "üîß Worker HTTP: $WORKER_STATUS"
          echo "üìä Dashboard HTTP: $DASHBOARD_STATUS"

      # ============================================
      # POST DEPLOYMENT SUMMARY
      # ============================================
      - name: üìù Post Deployment Summary
        uses: actions/github-script@v7
        with:
          script: |
            const schedulerUrl = '${{ steps.deploy-scheduler.outputs.scheduler_url }}';
            const workerUrl = '${{ steps.deploy-worker.outputs.worker_url }}';
            const dashboardUrl = '${{ steps.deploy-dashboard.outputs.dashboard_url }}';
            const tag = context.ref.replace('refs/tags/', '');

            const schedulerStatus = '${{ steps.verify.outputs.scheduler_status }}';
            const workerStatus = '${{ steps.verify.outputs.worker_status }}';
            const dashboardStatus = '${{ steps.verify.outputs.dashboard_status }}';

            const getStatusEmoji = (status) => {
              if (status === '200' || status === '302') return '‚úÖ';
              if (status === '000') return '‚è≥';
              return '‚ö†Ô∏è';
            };

            const summary = `
            # üöÄ CASS-Lite v2 Deployment Summary

            **Version:** \`${tag}\`
            **Region:** \`${{ env.REGION }}\`
            **Deployed at:** ${new Date().toUTCString()}

            ---

            ## üì¶ Deployed Services

            | Service | Status | URL |
            |---------|--------|-----|
            | üß† Scheduler Function | ${getStatusEmoji(schedulerStatus)} HTTP ${schedulerStatus} | [${schedulerUrl}](${schedulerUrl}) |
            | üîß Worker Function | ${getStatusEmoji(workerStatus)} HTTP ${workerStatus} | [${workerUrl}](${workerUrl}) |
            | üìä Dashboard | ${getStatusEmoji(dashboardStatus)} HTTP ${dashboardStatus} | [${dashboardUrl}](${dashboardUrl}) |

            ---

            ## üåü Quick Actions

            ### Test the Scheduler
            \`\`\`bash
            curl -X POST "${schedulerUrl}" \\
              -H "Content-Type: application/json" \\
              -d '{"test": true}'
            \`\`\`

            ### View Dashboard
            Open in browser: [${dashboardUrl}](${dashboardUrl})

            ### Monitor Logs
            \`\`\`bash
            # Scheduler logs
            gcloud functions logs read cass-scheduler --gen2 --region=${{ env.REGION }} --limit=50

            # Worker logs
            gcloud functions logs read cass-worker --gen2 --region=${{ env.REGION }} --limit=50

            # Dashboard logs
            gcloud run services logs read cass-lite-dashboard --region=${{ env.REGION }} --limit=50
            \`\`\`

            ---

            ## üéØ Deployment Details

            - **Python Runtime:** ${{ env.PYTHON_VERSION }}
            - **Project ID:** \`${{ env.PROJECT_ID }}\`
            - **Build ID:** \`${context.sha.substring(0, 7)}\`
            - **Triggered by:** ${context.actor}

            ---

            ## üìä Resource Configuration

            | Service | Memory | CPU | Timeout | Max Instances |
            |---------|--------|-----|---------|---------------|
            | Scheduler | 512MB | Auto | 540s | 10 |
            | Worker | 256MB | Auto | 300s | 50 |
            | Dashboard | 1GB | 1 vCPU | 300s | 5 |

            ---

            ## üîó Useful Links

            - [View Functions](https://console.cloud.google.com/functions/list?project=${{ env.PROJECT_ID }})
            - [View Cloud Run Services](https://console.cloud.google.com/run?project=${{ env.PROJECT_ID }})
            - [View Firestore Data](https://console.cloud.google.com/firestore/databases/-default-/data/panel?project=${{ env.PROJECT_ID }})
            - [View Logs Explorer](https://console.cloud.google.com/logs/query?project=${{ env.PROJECT_ID }})

            ---

            **üéâ Deployment completed successfully!**
            `;

            await core.summary
              .addRaw(summary)
              .write();

      # ============================================
      # HANDLE FAILURES
      # ============================================
      - name: ‚ùå Deployment Failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');

            const summary = `
            # ‚ùå CASS-Lite v2 Deployment Failed

            **Version:** \`${tag}\`
            **Region:** \`${{ env.REGION }}\`
            **Failed at:** ${new Date().toUTCString()}

            ---

            ## üîç Troubleshooting Steps

            1. **Check Service Account Permissions**
               - Ensure \`GCP_SA_KEY\` secret is set correctly
               - Required roles: Cloud Functions Admin, Cloud Run Admin, Artifact Registry Writer

            2. **Verify Project Configuration**
               - Project ID: \`${{ env.PROJECT_ID }}\`
               - Region: \`${{ env.REGION }}\`
               - APIs enabled: Cloud Functions, Cloud Run, Artifact Registry

            3. **Review Logs**
               - Check workflow logs for specific error messages
               - Look for authentication or permission errors

            4. **Common Issues**
               - Missing \`GCP_SA_KEY\` in repository secrets
               - Insufficient quota in Google Cloud project
               - Network or API rate limiting

            ---

            ## üìù Next Steps

            1. Review the [Actions logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Fix the issue
            3. Re-tag or create a new tag to trigger deployment again

            \`\`\`bash
            # Fix the issue, then:
            git tag -d ${tag}
            git push origin :refs/tags/${tag}
            git tag ${tag}
            git push origin ${tag}
            \`\`\`
            `;

            await core.summary
              .addRaw(summary)
              .write();

            core.setFailed('Deployment failed. Check the summary for details.');
